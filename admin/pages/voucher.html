<div class="page-heading">
    <h3>Voucher</h3>
</div>

<div class="page-content">
    <div class="row">
        <div class="col-6 col-lg-4 col-md-6">
            <div class="card">
                <div class="card-body px-3 py-4-5">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="stats-icon green">
                                <i class="iconly-boldArrow---Down-Circle"></i>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6 class="text-muted font-semibold">Pemasukan</h6>
                            <h6 class="font-extrabold mb-0" id="status-pemasukan"></h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-4 col-md-6">
            <div class="card">
                <div class="card-body px-3 py-4-5">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="stats-icon blue">
                                <i class="iconly-boldUser"></i>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6 class="text-muted font-semibold">Reseller</h6>
                            <h6 class="font-extrabold mb-0" id="status-reseller"></h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-4 col-md-6">
            <div class="card">
                <div class="card-body px-3 py-4-5">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="stats-icon purple">
                                <i class="iconly-boldActivity"></i>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6 class="text-muted font-semibold">Total Transaksi</h6>
                            <h6 class="font-extrabold mb-0" id="status-total-transaksi"></h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- <div class="col-6 col-lg-3 col-md-6">
            <div class="card">
                <div class="card-body px-3 py-4-5">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="stats-icon red">
                                <i class="iconly-boldShield-Fail"></i>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6 class="text-muted font-semibold">Target Kurang</h6>
                            <h6 class="font-extrabold mb-0">1</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div> -->
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="reseller-tab" data-bs-toggle="tab" href="#reseller" role="tab"
                                aria-controls="reseller" aria-selected="false">Reseller</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="paket-tab" data-bs-toggle="tab" href="#paket" role="tab"
                                aria-controls="paket" aria-selected="false">Paket</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link " id="transaksi-tab" data-bs-toggle="tab" href="#transaksi"
                                role="tab" aria-controls="transaksi" aria-selected="false">Transaksi</a>
                        </li>
                        
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <!-- Menu Transaksi -->
                        <div class="tab-pane fade" id="transaksi" role="tabpanel"
                            aria-labelledby="transaksi-tab">
                            <div class="row justify-content-between">
                                <div class="col-auto">
                                    <div class="form-floating">
                                        <button class="btn btn-primary" id="btn-tambah-transaksi">Tambah</button>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="cariInvoice" placeholder="Cari">
                                        <label for="cariInvoice">Cari</label>
                                    </div>
                                </div>
                            </div>

                            <table id="table-transaksi" class="table table-hover position-relative" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>id_pelanggan</th>
                                        <th>id_akun_reseller</th>
                                        <th>id_transaksi_voucher</th>
                                        <th>Waktu</th>
                                        <th>Nama</th>
                                        <th>Alamat</th>
                                        <th>Total</th>
                                        <th>Opsi</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>

                        <!-- Menu Reseller -->
                        <div class="tab-pane fade show active" id="reseller" role="tabpanel" aria-labelledby="reseller-tab">
                            <div class="row justify-content-between" id="resellerFilter">
                                <div class="col-auto">
                                    <div class="form-floating">
                                        <button class="btn btn-primary" id="btn-tambah-reseller">Tambah</button>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="cari-reseller" placeholder="Cari">
                                        <label for="cari-reseller">Cari</label>
                                    </div>
                                </div>
                            </div>

                            <table id="table-reseller" class="table table-hover position-relative" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>id_pelanggan</th>
                                        <th>id_akun_reseller</th>
                                        <th>Nama</th>
                                        <th>Alamat</th>
                                        <th>IP Router</th>
                                        <th>Trx Bulan Ini</th>
                                        <th>Opsi</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>

                        <!-- Menu Paket -->
                        <div class="tab-pane fade" id="paket" role="tabpanel" aria-labelledby="paket-tab">
                            <button type="button" class="btn btn-primary" id="btn-tambah-paket">Tambah</button>

                            <table id="table-paket" class="table table-hover position-relative" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>_id_paket_voucher</th>
                                        <th>Nama</th>
                                        <th>Kecepatan</th>
                                        <th>Durasi</th>
                                        <th>Harga Beli</th>
                                        <th>Harga Jual</th>
                                        <th>Target Bonus</th>
                                        <th>Jumlah Bonus</th>
                                        <th>Opsi</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Paket -->
<div class="modal fade" id="modal-paket">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-paket" class="row">
                    <div class="col-12 mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="nama" placeholder="Nama">
                            <label for="nama">Nama</label>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="durasi" placeholder="Durasi">
                            <label for="durasi">Durasi</label>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="kecepatan" placeholder="Kecepatan">
                            <label for="kecepatan">Kecepatan</label>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="form-floating">
                            <input type="number" class="form-control" name="harga_beli" placeholder="Harga beli">
                            <label for="harga_beli">Harga beli</label>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="form-floating">
                            <input type="number" class="form-control" name="harga_jual" placeholder="Harga jual">
                            <label for="harga_jual">Harga jual</label>
                        </div>
                    </div>
                    <div class="col-12 mb-3">
                        <div class="form-floating">
                            <input type="number" class="form-control" name="target_bonus" placeholder="Target bonus">
                            <label for="target_bonus">Target bonus</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-floating">
                            <input type="number" class="form-control" name="jumlah_bonus" placeholder="Jumlah bonus">
                            <label for="jumlah_bonus">Jumlah bonus</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success btn-submit">Simpan</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reseller-->
<div class="modal fade" id="modal-reseller">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form class="row" id="form-reseller" enctype='multipart/form-data'>
                    <div class="col-12 col-lg-6 mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="nama" placeholder="Nama reseller" required>
                            <label for="nama">Nama reseller<sup class="text-danger">*</sup></label>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6 mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="ip_router" placeholder="IP router" required>
                            <label for="ip_router">IP router<sup class="text-danger">*</sup></label>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6 mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="username_akun" placeholder="Username akun"
                                required>
                            <label for="username_akun">Username akun<sup class="text-danger">*</sup></label>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6 mb-3">
                        <div class="form-floating input-group">
                            <input type="password" class="form-control" name="password_akun" placeholder="Password akun"
                                required>
                            <div class="input-group-text" style="font-size: 0.8em">
                                <input class="form-check-input me-2" type="checkbox" name="show_password"> Show
                            </div>
                            <label for="password_akun">Password akun<sup class="text-danger">*</sup></label>
                        </div>
                    </div>

                    <div class="col-12">
                        <hr>
                    </div>

                    <div class="col-12 col-lg-4 mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="nik" placeholder="NIK">
                            <label for="nik">NIK</label>
                        </div>
                    </div>
                    <div class="col-12 col-lg-4 mb-3">
                        <div class="form-floating">
                            <select class="form-select" name="jenis_kelamin">
                                <option value="" selected disabled hidden>Pilih</option>
                                <option value="Laki-Laki">Laki-Laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                            <label for="jenis_kelamin">Jenis Kelamin</label>
                        </div>

                    </div>
                    <div class="col-12 col-lg-4 mb-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="kontak" placeholder="Kontak">
                            <label for="kontak">Kontak</label>
                        </div>
                    </div>
                    <div class="col-12 col-lg-4 mb-3">
                        <div class="input-group form-floating">
                            <select class="form-select" name="alamat" required>
                                <option value="" selected disabled hidden>Pilih</option>
                                <option value="_buat_baru">Buat baru</option>
                            </select>
                            <label for="alamat">Alamat<sup class="text-danger">*</sup></label>
                        </div>
                    </div>
                    <div class="col-12 col-lg-4 mb-3 d-none">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="alamat_baru" placeholder="Alamat baru">
                            <label for="alamat_baru">Alamat baru<sup class="text-danger">*</sup></label>
                        </div>
                    </div>
                    <div class="col-12 col-lg-4 mb-3">
                        <div class="form-floating">
                            <select class="form-select" name="jenis_pemasangan" required>
                                <option value="" selected disabled hidden>Pilih</option>
                                <option value="OLT">OLT</option>
                                <option value="Media converter">Media converter</option>
                                <option value="Antena">Antena</option>
                            </select>
                            <label for="jenis_pemasangan">Jenis pemasangan<sup class="text-danger">*</sup></label>
                        </div>

                    </div>
                    <div class="col-12 col-lg-4 mb-3">
                        <div class="form-floating">
                            <input type="date" class="form-control" name="tanggal_pemasangan">
                            <label for="tanggal_pemasangan">Tanggal pemasangan</label>
                        </div>
                    </div>
                    <div class="col-12 position-relative">
                        <label>Pin alamat</label>
                        <input type="hidden" name="lng">
                        <input type="hidden" name="lat">
                        <div class="map" id="reseller-map"></div>
                    </div>
                    <div class="col-12">
                        <label>Foto KTP</label>
                        <input type="file" class="filepond" name="foto_ktp" data-max-file-size="3MB">

                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-reset">Reset</button>
                <button class="btn btn-success btn-submit">Simpan</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Transaksi -->
<div class="modal fade" id="modal-transaksi">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-transaksi" class="row">
                    <div class="col-12">
                        <div class="form-group">
                            <label class="d-block" for="nama_pelanggan">Nama Pelanggan</label>
                            <div id="container-select-nama-pelanggan">
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <hr>
                    </div>

                    <div class="col-12" id="container-list-paket-voucher">
                    </div>

                    <div class="col-12">
                        <div class="form-group">
                            <label class="d-block">Grand Total</label>
                            <input type="number" class="form-control" value="0" name="grand_total" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success btn-submit">Simpan</button>
            </div>
        </div>
    </div>
</div>

<script>
    (() => {
        function refreshPage() {
            document.querySelector(".sidebar-item.active a").click();
        }

        function initPaket() {
            const form = document.forms["form-paket"];
            const modal = new bootstrap.Modal(document.getElementById('modal-paket'));

            // init datatables paket
            const options = {
                dom: "tipr",
                lengthChange: false,
                columnDefs: [{
                    targets: [0],
                    visible: false
                },
                {
                    targets: [4],
                    render: function (data, type, row, meta) {
                        return Number(row[4]).toLocaleString("id-ID");
                    }
                },
                {
                    targets: [5],
                    render: function (data, type, row, meta) {
                        return Number(row[5]).toLocaleString("id-ID");
                    }
                },
                {
                    targets: -1,
                    responsivePriority: 1,
                    data: null,
                    width: "20%",
                    render: function (data, type, row, meta) {
                        return `
                            <button class="btn btn-sm btn-light-warning btn-ubah" data-id-paket="${row[0]}" data-nama="${row[1]}">Ubah</button>
                            <button class="btn btn-sm btn-light-danger btn-hapus"  data-id-paket="${row[0]}" data-nama="${row[1]}">Hapus</button>
                        `;
                    }
                }
                ]
            }
            const table = createDataTable(
                "table-paket",
                server + "api/voucher/datatables-paket.php",
                options
            );

            function initOptionButton() {
                const btnRemove = document.querySelectorAll('#table-paket .btn-hapus');
                Array.from(btnRemove).forEach(el => {
                    el.onclick = evt => {
                        const id = evt.currentTarget.getAttribute("data-id-paket");
                        const nama = evt.currentTarget.getAttribute("data-nama");
                        Swal.fire({
                            title: 'Hapus ' + nama,
                            showCancelButton: true,
                            confirmButtonText: 'Hapus',
                            cancelButtonText: 'Batal',
                            showLoaderOnConfirm: true,
                            preConfirm: (login) => {
                                return fetch(server + "api/voucher/paket.php?id_paket_voucher=" + id, {
                                    method: "DELETE",
                                    headers: {
                                        "ContentType": "application/json;charset=utf-8"
                                    }
                                })
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error(response.statusText)
                                        }
                                        return response.json()
                                    })
                                    .then(result => {
                                        showToast(result.success, result.message);
                                        refreshPage();
                                    })
                                    .catch(error => {
                                        console.error(error);
                                    })
                            },
                            allowOutsideClick: () => !Swal.isLoading()
                        })
                    };
                });

                const btnUbah = document.querySelectorAll('#table-paket .btn-ubah');
                Array.from(btnUbah).forEach(el => {
                    el.onclick = evt => {
                        showModal("PUT", evt.currentTarget.getAttribute("data-id-paket"));
                    };
                });
            }

            table.on('draw', initOptionButton);

            initOptionButton();



            // init form paket
            document.getElementById("btn-tambah-paket").onclick = evt => {
                showModal("POST");
            };

            let method;
            let url;
            function showModal(m, id_paket) {
                form.reset();
                method = m;
                url = server + "api/voucher/paket.php";

                if (m == "POST") {
                    document.querySelector("#modal-paket .modal-title").textContent = "Tambah Paket";
                    document.querySelector("#modal-paket .modal-footer .btn-submit").textContent = "Simpan";
                } else {
                    document.querySelector("#modal-paket .modal-title").textContent = "Detail Paket";
                    document.querySelector("#modal-paket .modal-footer .btn-submit").textContent = "Simpan perubahan";

                    url += `?id_paket_voucher=${id_paket}`;
                    fetch(url)
                        .then(response => response.json())
                        .then(result => {
                            const data = result.data;
                            form.nama.value = data.nama;
                            form.kecepatan.value = data.kecepatan;
                            form.durasi.value = data.durasi;
                            form.harga_beli.value = data.harga_beli;
                            form.harga_jual.value = data.harga_jual;
                            form.target_bonus.value = data.target_bonus;
                            form.jumlah_bonus.value = data.jumlah_bonus;
                        });
                }
                modal.show();
            }

            function hideModal() {
                modal.hide();
                form.reset();
            }

            document.querySelector("#modal-paket .modal-footer .btn-submit").onclick = submitForm;
            function submitForm() {
                const formData = new FormData(form);
                let data = Object.fromEntries(formData);
                data = JSON.stringify(data);

                fetch(url, {
                    method: method,
                    body: data
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            hideModal();
                            refreshPage();
                        }
                        showToast(result.success, result.message);
                    });
            }
        }

        function initReseller() {
            const form = document.forms["form-reseller"];
            const modal = new bootstrap.Modal(document.getElementById('modal-reseller'));

            // init form
            document.getElementById("btn-tambah-reseller").onclick = evt => {
                showModal("POST");
            };

            form.show_password.onchange = showPassword;
            function showPassword() {
                form.password_akun.type = form.show_password.checked ? "text" : "password";
            }

            let method;
            let url;
            function showModal(m, id_akun_reseller) {
                form.reset();
                method = m;
                url = server + "api/voucher/reseller.php";

                if (m == "POST") {
                    document.querySelector("#modal-reseller .modal-title").textContent = "Tambah Reseller";
                    document.querySelector("#modal-reseller .modal-footer .btn-submit").textContent = "Simpan";
                } else if (m == "PUT") {
                    document.querySelector("#modal-reseller .modal-title").textContent = "Detail Reseller";
                    document.querySelector("#modal-reseller .modal-footer .btn-submit").textContent = "Simpan perubahan";

                    url += `?id_akun_reseller=${id_akun_reseller}`;
                    fetch(url)
                        .then(response => response.json())
                        .then(result => {
                            const data = result.data[0];
                            form.username_akun.value = data.username_akun;
                            form.password_akun.value = data.password_akun;
                            form.nama.value = data.nama;
                            form.ip_router.value = data.ip_router;
                            form.nik.value = data.nik;
                            form.jenis_kelamin.value = data.jenis_kelamin;
                            form.kontak.value = data.kontak;
                            form.alamat.value = data.id_alamat;
                            form.jenis_pemasangan.value = data.jenis_pemasangan;
                            form.tanggal_pemasangan.value = data.tanggal_pemasangan;
                            form.lng.value = data.lng;
                            form.lat.value = data.lat;
                            if (data.lng != "" && data.lat != "" && data.lng != null && data.lat != null) {
                                const coordinate = { lng: data.lng, lat: data.lat };
                                marker = new mapboxgl.Marker()
                                    .setLngLat(coordinate)
                                    .addTo(map);
                                map.flyTo({
                                    center: coordinate
                                });
                            }
                            if (data.url_foto_ktp !== "" && data.url_foto_ktp !== null) {
                                fotoKtp.addFile("../assets/images/foto-ktp/" + data.url_foto_ktp);
                            }
                        });
                }
                modal.show();
            }

            function hideModal() {
                modal.hide();
                form.reset();
            }

            //Alamat
            fetch(server + "api/pelanggan/alamat.php")
                .then(response => response.json())
                .then(result => {
                    result.data.forEach(el => {
                        const option = document.createElement("option");
                        option.value = el.id_alamat;
                        option.textContent = el.nama;
                        form.alamat.appendChild(option);
                    })
                });

            form.alamat.onchange = cekAlamat;
            function cekAlamat() {
                form.alamat_baru.closest(".col-12").classList.add("d-none");
                form.alamat_baru.required = false;

                if (form.alamat.value == "_buat_baru") {
                    form.alamat_baru.closest(".col-12").classList.remove("d-none");
                    form.alamat_baru.required = true;
                }
            }

            form.onreset = evt => {
                form.show_password.checked = false;
                showPassword();

                form.alamat.value = "";
                cekAlamat();

                if (marker) {
                    marker.remove();
                }
                fotoKtp.removeFile(0);
            };

            // Filepond foto ktp
            fotoKtp = FilePond.create(form.foto_ktp, {
                acceptedFileTypes: ['image/*'],
                required: false,
                instantUpload: false,
                allowRevert: false,
                allowProcess: false,
                labelIdle: "Drag & Drop your files or Browse",
                maxParallelUploads: 1,
                server: {
                    process: server + "api/pelanggan/upload-foto-ktp.php"
                },
            });

            // Mapbox pin alamat
            map = new mapboxgl.Map({
                container: 'reseller-map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [112.253302, -7.640462],
                zoom: 15
            });
            let marker;

            map.on("click", e => {
                if (marker) {
                    marker.remove();
                }
                const coordinate = e.lngLat;
                marker = new mapboxgl.Marker()
                    .setLngLat(coordinate)
                    .addTo(map);
                form.lng.value = coordinate.lng;
                form.lat.value = coordinate.lat;
            });

            map.on('idle', function () {
                map.resize();
            });

            document.querySelector("#modal-reseller .modal-footer .btn-reset").onclick = () => {
                form.reset();
            }

            document.querySelector("#modal-reseller .modal-footer .btn-submit").onclick = () => {
                submitForm();
            }

            function submitForm() {
                const formData = new FormData(form);
                let data = Object.fromEntries(formData);
                data = JSON.stringify(data);

                fetch(url, {
                    method: method,
                    body: data
                })
                    .then(response => response.json())
                    .then(result => {
                        const length = fotoKtp.getFiles().length;
                        if (length > 0) {
                            fotoKtp.getFile(0).setMetadata("id_pelanggan", result.data.id_pelanggan);
                            fotoKtp.processFiles().then(file => {
                                showToast(result.success, result.message);
                                if (result.success) {
                                    hideModal();
                                }
                                refreshPage();
                            });
                        } else {
                            showToast(result.success, result.message);
                            if (result.success) {
                                hideModal();
                            }
                            refreshPage();
                        }
                    });
            }


            // init datatables reseller
            const options = {
                dom: "tipr",
                lengthChange: false,
                columnDefs: [{
                    targets: [0, 1],
                    visible: false
                },
                {
                    targets: [5],
                    render: function (data, type, row, meta) {
                        return Number(row[5]).toLocaleString("id-ID");
                    }
                },
                {
                    targets: -1,
                    responsivePriority: 1,
                    data: null,
                    width: "20%",
                    render: function (data, type, row, meta) {
                        return `
                            <button class="btn btn-sm btn-light-secondary btn-detail" data-id-akun-reseller="${row[1]}" data-nama="${row[2]}">Detail</button>
                            <button class="btn btn-sm btn-light-danger btn-hapus"  data-id-pelanggan="${row[0]}" data-nama="${row[2]}">Hapus</button>
                        `;
                    }
                }
                ]
            }
            const table = createDataTable(
                "table-reseller",
                server + "api/voucher/datatables-reseller.php",
                options
            );

            function initOptionButton() {
                const btnRemove = document.querySelectorAll('#table-reseller .btn-hapus');
                Array.from(btnRemove).forEach(el => {
                    el.onclick = evt => {
                        const id = evt.currentTarget.getAttribute("data-id-pelanggan");
                        const nama = evt.currentTarget.getAttribute("data-nama");
                        Swal.fire({
                            title: 'Hapus ' + nama,
                            showCancelButton: true,
                            confirmButtonText: 'Hapus',
                            cancelButtonText: 'Batal',
                            showLoaderOnConfirm: true,
                            preConfirm: (login) => {
                                return fetch(server + "api/voucher/reseller.php?id_pelanggan=" + id, {
                                    method: "DELETE",
                                    headers: {
                                        "ContentType": "application/json;charset=utf-8"
                                    }
                                })
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error(response.statusText)
                                        }
                                        return response.json()
                                    })
                                    .then(result => {
                                        showToast(result.success, result.message);
                                        refreshPage();
                                    })
                                    .catch(error => {
                                        console.error(error);
                                    })
                            },
                            allowOutsideClick: () => !Swal.isLoading()
                        })
                    };
                });

                const btnDetail = document.querySelectorAll('#table-reseller .btn-detail');
                Array.from(btnDetail).forEach(el => {
                    el.onclick = evt => {
                        showModal("PUT", evt.currentTarget.getAttribute("data-id-akun-reseller"));
                    };
                });
            }

            table.on('draw', initOptionButton);

            initOptionButton();
        }

        function initTransaksi() {
            const form = document.forms["form-transaksi"];
            const modal = new bootstrap.Modal(document.getElementById('modal-transaksi'));

            // init datatables transaksi
            const options = {
                dom: "tipr",
                lengthChange: false,
                columnDefs: [{
                    targets: [0, 1, 2],
                    visible: false
                },
                {
                    targets: [3],
                    render: function (data, type, row, meta) {
                        return dayjs(row[3]).fromNow();
                    }
                },
                {
                    targets: [6],
                    render: function (data, type, row, meta) {
                        return Number(row[6]).toLocaleString("id-ID");;
                    }
                },
                {
                    targets: -1,
                    responsivePriority: 1,
                    data: null,
                    width: "20%",
                    render: function (data, type, row, meta) {
                        return `
                            <!-- <button class="btn btn-sm btn-light-secondary btn-detail" data-id-transaksi="${row[2]}">Detail</button> -->
                            <button class="btn btn-sm btn-light-danger btn-hapus"  data-id-transaksi="${row[2]}">Hapus</button>
                        `;
                    }
                }
                ]
            }
            const table = createDataTable(
                "table-transaksi",
                server + "api/voucher/datatables-transaksi.php",
                options
            );

            function initOptionButton() {
                const btnRemove = document.querySelectorAll('#table-transaksi .btn-hapus');
                Array.from(btnRemove).forEach(el => {
                    el.onclick = evt => {
                        const id = evt.currentTarget.getAttribute("data-id-transaksi");
                        Swal.fire({
                            title: 'Hapus?',
                            showCancelButton: true,
                            confirmButtonText: 'Hapus',
                            cancelButtonText: 'Batal',
                            showLoaderOnConfirm: true,
                            preConfirm: (login) => {
                                return fetch(server + "api/voucher/transaksi.php?id_transaksi_voucher=" + id, {
                                    method: "DELETE",
                                    headers: {
                                        "ContentType": "application/json;charset=utf-8"
                                    }
                                })
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error(response.statusText)
                                        }
                                        return response.json()
                                    })
                                    .then(result => {
                                        showToast(result.success, result.message);
                                        refreshPage();
                                    })
                                    .catch(error => {
                                        console.error(error);
                                    })
                            },
                            allowOutsideClick: () => !Swal.isLoading()
                        })
                    };
                });

                const btnDetail = document.querySelectorAll('#table-transaksi .btn-detail');
                Array.from(btnDetail).forEach(el => {
                    el.onclick = evt => {
                        showModal("PUT", evt.currentTarget.getAttribute("data-id-transaksi"));
                    };
                });
            }

            table.on('draw', initOptionButton);

            initOptionButton();



            // init form transaksi
            document.getElementById("btn-tambah-transaksi").onclick = evt => {
                showModal("POST");
            };

            let method;
            let url;
            let data_paket = [];
            let grandTotal;
            function showModal(m, id_transaksi) {
                const container = document.getElementById("container-select-nama-pelanggan");
                container.innerHTML = `
                    <select class="w-100" name="id_akun_reseller" id="select_reseller">
                        <option value="" selected disabled hidden>Pilih</option>
                    </select>
                `;
                fetch(server + "api/voucher/reseller.php").then(response => response.json()).then(result => {
                    result.data.forEach(e => {
                        const select = container.querySelector("select");
                        const option = document.createElement("option");
                        option.value = e.id_akun_reseller;
                        option.textContent = e.nama + " - " + e.alamat;
                        select.appendChild(option);
                    });
                    $('#select_reseller').select2();
                });

                const container2 = document.getElementById("container-list-paket-voucher");
                container2.innerHTML = "";
                fetch(server + "api/voucher/paket.php").then(response => response.json()).then(result => {
                    result.data.forEach(e => {
                        const row = document.createElement("div");
                        row.classList.add("row");
                        row.innerHTML = `
                            <div class="col-12">
                                <label class="d-block"><strong>${e.nama} - ${e.durasi}</strong></label>
                                <div class="row">
                                    <div class="col-3">
                                        <div class="form-group">
                                            <label class="d-block">Jumlah</label>
                                            <input type="number" class="form-control" min="0" value="0" name="jumlah-paket_${e.id_paket_voucher}">
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="form-group">
                                            <label class="d-block">Bonus</label>
                                            <input type="number" class="form-control" value="0" readonly name="bonus-paket_${e.id_paket_voucher}">
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-group">
                                            <label class="d-block">Total</label>
                                            <input type="number" class="form-control" value="0" readonly name="total-paket_${e.id_paket_voucher}">
                                            <input type="hidden" name="total_${e.id_paket_voucher}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <hr>
                            </div>
                        `;
                        row.querySelector(`input[name=jumlah-paket_${e.id_paket_voucher}]`).oninput = evt => {
                            const bonus = (parseInt((Number(evt.currentTarget.value) / Number(e.target_bonus))) * Number(e.jumlah_bonus));
                            const total = Number(evt.currentTarget.value) * Number(e.harga_beli);
                            row.querySelector(`input[name=bonus-paket_${e.id_paket_voucher}]`).value = bonus;
                            row.querySelector(`input[name=total-paket_${e.id_paket_voucher}]`).value = total.toLocaleString("id-ID");
                            row.querySelector(`input[name=total_${e.id_paket_voucher}]`).value = total;
                            hitungGrandTotal();

                            const data = {
                                id_paket_voucher: e.id_paket_voucher,
                                jumlah_pembelian: Number(evt.currentTarget.value),
                                bonus: bonus
                            };
                            const index = data_paket.findIndex(v => v.id_paket_voucher == e.id_paket_voucher);
                            if (index !== -1) {
                                data_paket[index] = data;
                            } else {
                                data_paket.push(data);
                            }
                        }
                        container2.appendChild(row);
                    });

                    function hitungGrandTotal() {
                        grandTotal = 0;
                        result.data.forEach(e => {
                            grandTotal += Number(form.querySelector(`input[name=total_${e.id_paket_voucher}]`).value);
                        });
                        form.grand_total.value = grandTotal.toLocaleString("id-ID");
                    }
                });

                form.reset();
                method = m;
                url = server + "api/voucher/transaksi.php";

                if (m == "POST") {
                    document.querySelector("#modal-transaksi .modal-title").textContent = "Tambah transaksi";
                    document.querySelector("#modal-transaksi .modal-footer .btn-submit").textContent = "Simpan";
                } else {
                    document.querySelector("#modal-transaksi .modal-title").textContent = "Detail transaksi";
                    document.querySelector("#modal-transaksi .modal-footer .btn-submit").textContent = "Simpan perubahan";

                    // url += `?id_transaksi_voucher=${id_transaksi}`;
                    // fetch(url)
                    //     .then(response => response.json())
                    //     .then(result => {
                    //         const data = result.data;
                    //         form.nama.value = data.nama;
                    //         form.kecepatan.value = data.kecepatan;
                    //         form.durasi.value = data.durasi;
                    //         form.harga_beli.value = data.harga_beli;
                    //         form.harga_jual.value = data.harga_jual;
                    //         form.target_bonus.value = data.target_bonus;
                    //         form.jumlah_bonus.value = data.jumlah_bonus;
                    //     });
                }
                modal.show();
            }

            function hideModal() {
                modal.hide();
                form.reset();
            }

            document.querySelector("#modal-transaksi .modal-footer .btn-submit").onclick = submitForm;
            function submitForm() {
                let data = {
                    data_paket: data_paket,
                    grand_total: grandTotal,
                    id_akun_reseller: form.id_akun_reseller.value
                };
                data = JSON.stringify(data);
                
                fetch(url, {
                    method: method,
                    body: data
                })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            hideModal();
                            refreshPage();
                        }
                        showToast(result.success, result.message);
                    });
            }
        }

        function refreshStatus() {
            fetch(server + "api/voucher/index.php").then(response => response.json()).then(result => {
                document.getElementById("status-pemasukan").textContent = Number(result.data.pemasukan).toLocaleString("id-ID");
                document.getElementById("status-reseller").textContent = result.data.reseller;
                document.getElementById("status-total-transaksi").textContent = result.data.total_transaksi;
            });
        }

        const scripts = [
            "../assets/vendors/filepond/filepond.min.js",
            "../assets/vendors/filepond/plugin/image-preview/filepond-plugin-image-preview.min.js",
            "../assets/vendors/filepond/plugin/image-exif-orientation/filepond-plugin-image-exif-orientation.min.js",
            "../assets/vendors/filepond/plugin/file-validate-size/filepond-plugin-file-validate-size.min.js",
            "../assets/vendors/filepond/plugin/file-rename/filepond-plugin-file-rename.min.js",
            "../assets/vendors/filepond/plugin/file-validate-type/filepond-plugin-file-validate-type.min.js",
            "../assets/vendors/filepond/plugin/file-rename/filepond-plugin-file-rename.min.js",
            "../assets/vendors/filepond/plugin/file-metadata/filepond-plugin-file-metadata.min.js",
            "https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js"
        ]

        loadAllScripts(scripts, initPage)

        function initPage() {
            FilePond.registerPlugin(
                FilePondPluginImagePreview,
                FilePondPluginImageExifOrientation,
                FilePondPluginFileValidateSize,
                FilePondPluginFileValidateType,
                FilePondPluginFileRename,
                FilePondPluginFileMetadata
            );

            mapboxgl.accessToken = 'pk.eyJ1IjoiYWxkaWt1cnciLCJhIjoiY2t1ZTRkZm9jMDh4bjJwbnZvZTZ6OG93MiJ9.c6lXJbri6dbYO0p0t8u8Rw';


            initPaket();
            initReseller();
            initTransaksi();
            refreshStatus();
        }
    })();
</script>